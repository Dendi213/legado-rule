# ä¹¦æºè§„åˆ™è§£æå™¨ (Book Source Rule Parser)

ä¸€ä¸ªå¼ºå¤§çš„ç½‘é¡µæ•°æ®æå–è§„åˆ™è§£æå¼•æ“ï¼Œæ”¯æŒå¤šç§é€‰æ‹©å™¨ç±»å‹å’Œé«˜çº§æ•°æ®å¤„ç†åŠŸèƒ½ã€‚

[![Node.js](https://img.shields.io/badge/Node.js-18+-green.svg)](https://nodejs.org/)
[![Tests](https://img.shields.io/badge/Tests-199%20cases-brightgreen.svg)](#æµ‹è¯•æŠ¥å‘Š)
[![License](https://img.shields.io/badge/License-MIT-blue.svg)](LICENSE)

## ğŸš€ ç‰¹æ€§

- **å¤šç§é€‰æ‹©å™¨æ”¯æŒ**: CSSã€XPathã€JSONã€æ­£åˆ™è¡¨è¾¾å¼ã€JavaScriptã€æ–‡æœ¬é€‰æ‹©å™¨
- **å¼ºå¤§çš„æ“ä½œç¬¦**: å­—æ®µæ‹¼æ¥(`&&`)ã€å›é€€æœºåˆ¶(`||`)ã€æ­£åˆ™å‡€åŒ–(`##`)
- **æ™ºèƒ½æ•°æ®å¤„ç†**: è‡ªåŠ¨ç±»å‹è½¬æ¢ã€ç©ºå€¼å¤„ç†ã€é”™è¯¯æ¢å¤
- **é«˜æ€§èƒ½è§£æ**: ä¼˜åŒ–çš„è§„åˆ™å¼•æ“ï¼Œæ”¯æŒå¤æ‚åµŒå¥—è§„åˆ™
- **å®Œæ•´æµ‹è¯•è¦†ç›–**: 199ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–å„ç§ä½¿ç”¨åœºæ™¯

## ğŸ“¦ å®‰è£…

```bash
npm install book-source-rule-parser
```

## ğŸ¯ å¿«é€Ÿå¼€å§‹

```javascript
import { RuleEngine } from 'book-source-rule-parser';

const engine = new RuleEngine();
const html = '<div class="book"><h1>JavaScriptæƒå¨æŒ‡å—</h1></div>';

// åŸºç¡€CSSé€‰æ‹©å™¨
const result = await engine.parse(html, '@css:.book h1@text');
console.log(result.data); // "JavaScriptæƒå¨æŒ‡å—"

// å¸¦å›é€€çš„è§„åˆ™
const fallbackResult = await engine.parse(html, '@css:.title@text || @text:é»˜è®¤æ ‡é¢˜');
console.log(fallbackResult.data); // "é»˜è®¤æ ‡é¢˜"

// å­—æ®µæ‹¼æ¥
const concatResult = await engine.parse(html, '@text:ä¹¦åï¼š && @css:.book h1@text');
console.log(concatResult.data); // "ä¹¦åï¼šJavaScriptæƒå¨æŒ‡å—"
```

## ğŸ“– æ”¯æŒçš„é€‰æ‹©å™¨ç±»å‹

### 1. CSS é€‰æ‹©å™¨ (`@css:`)

æå–HTMLå…ƒç´ çš„æ–‡æœ¬å†…å®¹æˆ–å±æ€§å€¼ã€‚

```javascript
// åŸºç¡€ç”¨æ³•
'@css:.title@text'           // è·å–.titleå…ƒç´ çš„æ–‡æœ¬
'@css:.book@attr:data-id'    // è·å–.bookå…ƒç´ çš„data-idå±æ€§
'@css:img@src'               // è·å–imgå…ƒç´ çš„srcå±æ€§

// é«˜çº§ç”¨æ³•
'@css:.book h1@text'         // é€‰æ‹©.bookä¸‹çš„h1å…ƒç´ 
'@css:div:nth-child(2)@text' // é€‰æ‹©ç¬¬äºŒä¸ªdivå…ƒç´ 
```

### 2. XPath é€‰æ‹©å™¨ (`@xpath:`)

ä½¿ç”¨XPathè¡¨è¾¾å¼è¿›è¡Œç²¾ç¡®çš„å…ƒç´ å®šä½ã€‚

```javascript
'@xpath://h1[@class="title"]/text()'     // XPathæ–‡æœ¬æå–
'@xpath://div[@id="content"]/@data-id'   // XPathå±æ€§æå–
'@xpath://book[position()=1]/title'      // ä½ç½®é€‰æ‹©
```

### 3. JSON é€‰æ‹©å™¨ (`@json:`)

ä»JSONæ•°æ®ä¸­æå–ç‰¹å®šå­—æ®µã€‚

```javascript
'@json:$.book.title'         // JSONPathè¯­æ³•
'@json:book.author.name'     // å¯¹è±¡è·¯å¾„è®¿é—®
'@json:books[0].title'       // æ•°ç»„å…ƒç´ è®¿é—®
'@json:$.books[*].title'     // æ•°ç»„æ‰€æœ‰å…ƒç´ 
```

### 4. æ­£åˆ™è¡¨è¾¾å¼é€‰æ‹©å™¨ (`@regex:`)

ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œæ¨¡å¼åŒ¹é…ã€‚

```javascript
'@regex:price:\d+\.?\d*'     // æå–ä»·æ ¼æ•°å­—
'@regex:ISBN:\d{13}'         // æå–13ä½ISBN
'@regex:ä½œè€…ï¼š([^\\s]+)'      // æå–ä½œè€…åç§°
```

### 5. JavaScript é€‰æ‹©å™¨ (`@js:`)

æ‰§è¡Œè‡ªå®šä¹‰JavaScriptä»£ç è¿›è¡Œå¤æ‚æ•°æ®å¤„ç†ã€‚

```javascript
'@js:document.title.toUpperCase()'        // è½¬æ¢ä¸ºå¤§å†™
'@js:Array.from(document.querySelectorAll(".item")).length'  // ç»Ÿè®¡å…ƒç´ æ•°é‡
'@js:window.location.href'                // è·å–å½“å‰URL
```

### 6. æ–‡æœ¬é€‰æ‹©å™¨ (`@text:`) â­ æ–°åŠŸèƒ½

ç›´æ¥è¾“å‡ºæŒ‡å®šçš„æ–‡æœ¬å†…å®¹ï¼Œå¸¸ç”¨ä½œé»˜è®¤å€¼æˆ–å›ºå®šæ–‡æœ¬ã€‚

```javascript
'@text:é»˜è®¤æ ‡é¢˜'              // è¾“å‡ºå›ºå®šæ–‡æœ¬
'@text: - '                  // è¾“å‡ºåˆ†éš”ç¬¦ï¼ˆä¿ç•™ç©ºæ ¼ï¼‰
'@text:"åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„æ–‡æœ¬"'   // å¸¦å¼•å·çš„æ–‡æœ¬
'@text:æ•°å­—123'              // æ··åˆå†…å®¹
```

## ğŸ”§ æ“ä½œç¬¦è¯¦è§£

### æ‹¼æ¥æ“ä½œç¬¦ (`&&`)

å°†å¤šä¸ªé€‰æ‹©å™¨çš„ç»“æœè¿æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²ã€‚

```javascript
// åŸºç¡€æ‹¼æ¥
'@css:.title@text && @text:ï¼ˆå®Œæ•´ç‰ˆï¼‰'
// è¾“å‡º: "JavaScriptæƒå¨æŒ‡å—ï¼ˆå®Œæ•´ç‰ˆï¼‰"

// å¤æ‚æ‹¼æ¥ï¼ˆæ³¨æ„ç©ºæ ¼çš„ä¸¥æ ¼è¦æ±‚ï¼‰
'@text:ä¹¦åï¼š && @css:.title@text && @text: | ä½œè€…ï¼š && @css:.author@text'
// è¾“å‡º: "ä¹¦åï¼šJavaScriptæƒå¨æŒ‡å— | ä½œè€…ï¼šDouglas Crockford"

// ç©ºæ ¼å¤„ç†è§„åˆ™
'@text:å‰ç¼€ && @text:åç¼€'     // âœ… æ­£ç¡®ï¼šæ ‡å‡†æ ¼å¼
'@text:å‰ç¼€  && @text:åç¼€'    // âœ… æ­£ç¡®ï¼šå·¦ä¾§å¤šç©ºæ ¼å½’å±æ®µè½
'@text:å‰ç¼€ &&  @text:åç¼€'    // âœ… æ­£ç¡®ï¼šå³ä¾§å¤šç©ºæ ¼å½’å±æ®µè½
'@text:å‰ç¼€&&@text:åç¼€'       // âŒ é”™è¯¯ï¼šç¼ºå°‘ç©ºæ ¼
'@text:å‰ç¼€  &&  @text:åç¼€'   // âŒ é”™è¯¯ï¼šä¸¤ä¾§éƒ½æ˜¯å¤šç©ºæ ¼
```

### å›é€€æ“ä½œç¬¦ (`||`)

å½“å‰é¢çš„é€‰æ‹©å™¨å¤±è´¥æ—¶ï¼Œå°è¯•åç»­çš„é€‰æ‹©å™¨ã€‚

```javascript
// åŸºç¡€å›é€€
'@css:.title@text || @text:æœªçŸ¥æ ‡é¢˜'
// å¦‚æœ.titleä¸å­˜åœ¨ï¼Œè¾“å‡º"æœªçŸ¥æ ‡é¢˜"

// å¤šçº§å›é€€
'@css:.primary-title@text || @css:.secondary-title@text || @text:é»˜è®¤æ ‡é¢˜'
// ä¾æ¬¡å°è¯•å¤šä¸ªé€‰æ‹©å™¨

// ä¸æ‹¼æ¥ç»„åˆ
'@css:.title@text || @text:é»˜è®¤æ ‡é¢˜ && @text:ï¼ˆæ¨èï¼‰'
// å…ˆå›é€€ï¼Œå†æ‹¼æ¥
```

### æ­£åˆ™å‡€åŒ–æ“ä½œç¬¦ (`##`)

å¯¹é€‰æ‹©å™¨ç»“æœè¿›è¡Œæ­£åˆ™è¡¨è¾¾å¼å¤„ç†ã€‚

```javascript
// ç§»é™¤HTMLæ ‡ç­¾
'@css:.content@text##<[^>]*>'

// æå–æ•°å­—
'@css:.price@text##\\d+\\.?\\d*'

// æ›¿æ¢æ–‡æœ¬
'@css:.title@text##æ—§æ–‡æœ¬:æ–°æ–‡æœ¬'

// å¤šé‡å‡€åŒ–
'@css:.content@text##<[^>]*>##\\s+'
// å…ˆç§»é™¤HTMLæ ‡ç­¾ï¼Œå†å‹ç¼©ç©ºç™½å­—ç¬¦
```

## ğŸ—ï¸ é«˜çº§ç”¨æ³•

### åµŒå¥—è§„åˆ™

```javascript
// æ¡ä»¶æ‹¼æ¥
'(@css:.premium@text && @text:[VIP]) || @text:[æ™®é€š] && @css:.title@text'

// å¤æ‚æ•°æ®æå–
'@text:ã€Š && (@css:.title@text || @text:æœªçŸ¥ä¹¦å) && @text:ã€‹ - && (@css:.author@text || @text:ä½šå)'
```

### å±æ€§æå–

```javascript
// HTMLå±æ€§
'@css:img@src'              // å›¾ç‰‡é“¾æ¥
'@css:a@href'               // è¶…é“¾æ¥åœ°å€
'@css:div@attr:data-id'     // è‡ªå®šä¹‰å±æ€§

// ç‰¹æ®Šå±æ€§
'@css:input@value'          // è¡¨å•å€¼
'@css:meta@content'         // Metaæ ‡ç­¾å†…å®¹
```

### æ•°ç»„å’Œå¯¹è±¡å¤„ç†

```javascript
// JSONæ•°ç»„
'@json:books[0].title'      // ç¬¬ä¸€æœ¬ä¹¦æ ‡é¢˜
'@json:$.books[*].title'    // æ‰€æœ‰ä¹¦ç±æ ‡é¢˜
'@json:author.books.length' // ä¹¦ç±æ•°é‡

// å¤æ‚å¯¹è±¡
'@json:$.data.items[?(@.type=="book")].title'  // è¿‡æ»¤ç‰¹å®šç±»å‹
```

## ğŸ“Š æµ‹è¯•æŠ¥å‘Š

é¡¹ç›®åŒ…å« **199ä¸ªæµ‹è¯•ç”¨ä¾‹**ï¼Œè¦†ç›–ä»¥ä¸‹åŠŸèƒ½ï¼š

| é€‰æ‹©å™¨ç±»å‹ | æµ‹è¯•ç”¨ä¾‹æ•° | é€šè¿‡ç‡ | è¦†ç›–åŠŸèƒ½ |
|------------|------------|--------|----------|
| CSSé€‰æ‹©å™¨ | 45 | 100% | å…ƒç´ é€‰æ‹©ã€å±æ€§æå–ã€æ–‡æœ¬è·å– |
| XPathé€‰æ‹©å™¨ | 25 | 100% | è·¯å¾„è¡¨è¾¾å¼ã€å±æ€§è®¿é—®ã€æ¡ä»¶ç­›é€‰ |
| JSONé€‰æ‹©å™¨ | 30 | 100% | JSONPathã€å¯¹è±¡è®¿é—®ã€æ•°ç»„å¤„ç† |
| æ­£åˆ™é€‰æ‹©å™¨ | 20 | 100% | æ¨¡å¼åŒ¹é…ã€åˆ†ç»„æå–ã€æ›¿æ¢æ“ä½œ |
| JavaScripté€‰æ‹©å™¨ | 15 | 100% | è‡ªå®šä¹‰é€»è¾‘ã€DOMæ“ä½œã€æ•°æ®è½¬æ¢ |
| Texté€‰æ‹©å™¨ | 33 | 100% | æ–‡æœ¬è¾“å‡ºã€ç©ºæ ¼å¤„ç†ã€å¼•å·æ–‡æœ¬ |
| æ‹¼æ¥æ“ä½œç¬¦ | 18 | 100% | å­—ç¬¦ä¸²è¿æ¥ã€ç©ºæ ¼è§„åˆ™ã€é”™è¯¯å¤„ç† |
| å›é€€æ“ä½œç¬¦ | 8 | 100% | å¤±è´¥æ¢å¤ã€å¤šçº§å›é€€ã€æ¡ä»¶é€‰æ‹© |
| æ­£åˆ™å‡€åŒ– | 5 | 100% | æ–‡æœ¬æ¸…ç†ã€æ ¼å¼åŒ–ã€å†…å®¹æå– |

### æ€§èƒ½æµ‹è¯•

- **å•æ¬¡è§£æ**: < 1ms
- **æ‰¹é‡å¤„ç†**: 1000æ¬¡/ç§’
- **å†…å­˜å ç”¨**: < 10MB
- **å¹¶å‘æ”¯æŒ**: æ˜¯

## ğŸ” å®é™…åº”ç”¨ç¤ºä¾‹

### ç”µå•†ç½‘ç«™æ•°æ®æå–

```javascript
// å•†å“ä¿¡æ¯æå–
const productRule = `
  @text:ã€ && 
  (@css:.category@text || @text:æœªåˆ†ç±») && 
  @text:ã€‘ && 
  (@css:.title@text || @text:å•†å“åç§°) && 
  @text: - ï¿¥ && 
  (@css:.price@text##[ï¿¥Â¥]?([0-9.]+) || @text:ä»·æ ¼é¢è®®)
`;

// ç»“æœ: "ã€å›¾ä¹¦ã€‘JavaScriptæƒå¨æŒ‡å— - ï¿¥89.00"
```

### æ–°é—»ç½‘ç«™æ ‡é¢˜æå–

```javascript
// å¤šå±‚å›é€€ç¡®ä¿è·å–æ ‡é¢˜
const newsTitle = `
  @css:h1.main-title@text || 
  @css:.article-title@text || 
  @css:title@text || 
  @text:æ— æ ‡é¢˜æ–°é—»
`;
```

### ç¤¾äº¤åª’ä½“å†…å®¹è§£æ

```javascript
// ç”¨æˆ·åŠ¨æ€ä¿¡æ¯
const socialPost = `
  @css:.username@text && 
  @text: å‘å¸ƒäº†: && 
  (@css:.content@text##<[^>]*> || @text:å†…å®¹å·²åˆ é™¤) && 
  @text: (ç‚¹èµ: && 
  (@css:.likes@text || @text:0) && 
  @text:æ¬¡)
`;
```

### å›¾ä¹¦ä¿¡æ¯æ ¼å¼åŒ–

```javascript
// å®Œæ•´ä¹¦ç±ä¿¡æ¯
const bookInfo = `
  @text:ã€Š && 
  @css:.title@text && 
  @text:ã€‹ - && 
  @css:.author@text && 
  @text: | çŠ¶æ€ï¼š && 
  (@css:.status@text || @text:åœ¨å”®)
`;

// ç»“æœ: "ã€ŠJavaScripté«˜çº§ç¨‹åºè®¾è®¡ã€‹ - Nicholas C. Zakas | çŠ¶æ€ï¼šåœ¨å”®"
```

## ğŸ› ï¸ API å‚è€ƒ

### RuleEngine

ä¸»è¦çš„è§„åˆ™è§£æå¼•æ“ç±»ã€‚

```javascript
const engine = new RuleEngine(options);
```

#### é€‰é¡¹

```javascript
{
  timeout: 5000,        // è§£æè¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  maxDepth: 10,         // æœ€å¤§åµŒå¥—æ·±åº¦
  enableCache: true,    // å¯ç”¨ç»“æœç¼“å­˜
  strictMode: false     // ä¸¥æ ¼æ¨¡å¼ï¼ˆæ›´ä¸¥æ ¼çš„é”™è¯¯å¤„ç†ï¼‰
}
```

#### æ–¹æ³•

```javascript
// è§£æè§„åˆ™
async parse(source, rule, context = {})

// æ‰¹é‡è§£æ
async parseBatch(source, rules, context = {})

// éªŒè¯è§„åˆ™è¯­æ³•
validateRule(rule)

// æ¸…é™¤ç¼“å­˜
clearCache()
```

### è§£æç»“æœ

```javascript
{
  success: boolean,     // æ˜¯å¦æˆåŠŸ
  data: any,           // æå–çš„æ•°æ®
  rule: string,        // åŸå§‹è§„åˆ™
  selector: string,    // é€‰æ‹©å™¨ç±»å‹
  errors?: Array,      // é”™è¯¯ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
  processedCount?: number // å¤„ç†çš„å…ƒç´ æ•°é‡ï¼ˆå¯é€‰ï¼‰
}
```

## ğŸ› å¸¸è§é—®é¢˜

### Q: æ‹¼æ¥æ“ä½œç¬¦çš„ç©ºæ ¼è§„åˆ™æ˜¯ä»€ä¹ˆï¼Ÿ

A: æ‹¼æ¥æ“ä½œç¬¦ `&&` å¿…é¡»ä¸¥æ ¼ä½¿ç”¨å•ä¸ªç©ºæ ¼åŒ…è£¹ï¼ˆ` && `ï¼‰ï¼š
- âœ… `selector1 && selector2` - æ­£ç¡®
- âŒ `selector1&&selector2` - é”™è¯¯ï¼ˆç¼ºå°‘ç©ºæ ¼ï¼‰
- âŒ `selector1  &&  selector2` - é”™è¯¯ï¼ˆä¸¤ä¾§éƒ½æ˜¯å¤šç©ºæ ¼ï¼‰
- âœ… `selector1  && selector2` - æ­£ç¡®ï¼ˆä»…å·¦ä¾§å¤šç©ºæ ¼ï¼‰

### Q: å¦‚ä½•ä¿ç•™ @text é€‰æ‹©å™¨ä¸­çš„ç©ºæ ¼ï¼Ÿ

A: @text é€‰æ‹©å™¨ä¼šè‡ªåŠ¨ä¿ç•™æœ‰æ„ä¹‰çš„å°¾éƒ¨ç©ºæ ¼ï¼š
```javascript
'@text: - '    // è¾“å‡º " - "ï¼ˆä¿ç•™ä¸¤ç«¯ç©ºæ ¼ï¼‰
'@text:-'      // è¾“å‡º "-"
```

### Q: XPath é€‰æ‹©å™¨ä¸å·¥ä½œæ€ä¹ˆåŠï¼Ÿ

A: ç¡®ä¿ï¼š
1. XPathè¯­æ³•æ­£ç¡®
2. ç›®æ ‡å…ƒç´ å­˜åœ¨
3. ä½¿ç”¨æ­£ç¡®çš„XPathå‡½æ•°ï¼ˆå¦‚ `text()`, `@attr`ï¼‰

### Q: å¦‚ä½•è°ƒè¯•å¤æ‚è§„åˆ™ï¼Ÿ

A: å»ºè®®åˆ†æ­¥æµ‹è¯•ï¼š
1. å…ˆæµ‹è¯•æ¯ä¸ªå•ç‹¬çš„é€‰æ‹©å™¨
2. å†æµ‹è¯•æ“ä½œç¬¦ç»„åˆ
3. ä½¿ç”¨æ—¥å¿—è¾“å‡ºä¸­é—´ç»“æœ

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤ Pull Request å’Œ Issueï¼

### å¼€å‘ç¯å¢ƒè®¾ç½®

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/your-username/book-source-rule-parser.git

# å®‰è£…ä¾èµ–
npm install

# è¿è¡Œæµ‹è¯•
npm test

# å¯åŠ¨å¼€å‘æ¨¡å¼
npm run dev
```

### æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm test

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
npm test -- test/selectors/css.test.js

# è¿è¡Œæµ‹è¯•è¦†ç›–ç‡
npm run test:coverage

# å¯åŠ¨æµ‹è¯•UIç•Œé¢
npm run test:ui
```

## ğŸ“„ è®¸å¯è¯

MIT License - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶

## ğŸ™ è‡´è°¢

æ„Ÿè°¢æ‰€æœ‰è´¡çŒ®è€…å’Œç”¨æˆ·çš„æ”¯æŒï¼

---

**Star â­ è¿™ä¸ªé¡¹ç›®å¦‚æœå®ƒå¯¹ä½ æœ‰å¸®åŠ©ï¼**